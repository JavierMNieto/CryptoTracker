!function(){"use strict";angular.module("txs",[]).factory("PagerService",function(){var e={GetPager:function(e,t,a){t=t||1,a=a||10;var s,l,o=Math.ceil(e/a);o<=10?(s=1,l=o):t<=6?(s=1,l=10):t+4>=o?(s=o-9,l=o):(s=t-5,l=t+4);var n=(t-1)*a,r=Math.min(n+a-1,e-1),i=_.range(s,l+1);return{totalItems:e,currentPage:t,pageSize:a,totalPages:o,startPage:s,endPage:l,startIndex:n,endIndex:r,pages:i}}};return e}).controller("txsController",["PagerService","orderByFilter","filterFilter","$scope",function(e,t,a,s){var l=this;l.txs=[],l.pager={},l.reverse=!1,l.dropText="Most Recent",l.collapseText="Show All Transactions",l.isCollapsed=!0,l.selection={type:"",data:{}},l.setPage=function(t){l.pager.totalPages<1&&(l.pager=e.GetPager(l.txs.length,t)),t<1||t>l.pager.totalPages||(l.pager=e.GetPager(l.txs.length,t),l.items=l.txs.slice(l.pager.startIndex,l.pager.endIndex+1),$(function(){$('[data-toggle="tooltip"]').tooltip({trigger:"hover"})}))},l.setTxs=function(e){null==e&&(e=l.prevTxs),l.txs=e,"Most Recent"===l.dropText?l.txs=t(l.txs,"time",!0):"Transaction Amount ↓"===l.dropText?l.txs=t(l.txs,"amount",!0):"Transaction Amount ↑"===l.dropText&&(l.txs=t(l.txs,"amount",!1)),l.setPage(1),l.selection={type:"",data:{}}},l.collapse=function(e){if(void 0!==e&&(l.isCollapsed=e),l.isCollapsed){l.isCollapsed=!1,l.collapseText="Collapse Transactions",$(function(){$('input[name="minTime"]').daterangepicker({singleDatePicker:!0,timePicker:!0,showDropdowns:!0,minDate:moment.unix($('div[name="dateTimes"]').attr("data-minDate")).format("M/DD/YY hh:mm A"),maxDate:moment.unix($('div[name="dateTimes"]').attr("data-maxDate")).format("M/DD/YY hh:mm A"),locale:{format:"M/DD/YY hh:mm A"}}),$('input[name="maxTime"]').daterangepicker({singleDatePicker:!0,timePicker:!0,showDropdowns:!0,minDate:moment.unix($('div[name="dateTimes"]').attr("data-minDate")).format("M/DD/YY hh:mm A"),maxDate:moment.unix($('div[name="dateTimes"]').attr("data-maxDate")).format("M/DD/YY hh:mm A"),locale:{format:"M/DD/YY hh:mm A"}})});var t=new Date;t.setDate(t.getDate()-30),l.graphFilters={node:{balance:{min:0,max:l.maxBal}},edge:{amount:{min:0,max:l.maxTx},time:{min:moment.unix(t.getTime()/1e3).format("M, DD, YY h:mm:ss A"),max:moment.unix(l.maxTime).format("M, DD, YY h:mm:ss A")}}},edges=allEdges.all,nodes=allNodes}else l.isCollapsed||(l.isCollapsed=!0,l.collapseText="Show All Transactions",edges=allEdges.collapsed,nodes=allNodes,l.graphFilters={node:{balance:{min:0,max:l.maxBal}},edge:{amount:{min:0,max:l.maxTotalTx},avgTx:{min:0,max:l.maxAvgTx},txsNum:{min:1,max:l.maxTxsNum}}});$(function(){$('[data-toggle="tooltip"]').tooltip({trigger:"hover"})}),l.currentId=0,l.setTxs(allEdges.all),l.prevTxs=l.txs,l.setFilters()},l.setTxs(allEdges.all);var o=t(l.txs,"value",!1),n=t(l.txs,"time",!1);function r(e){let t=_.map(e,"from"),a=_.map(e,"to"),s=[];for(var l=0;l<allEdges.all.length;l++){let e=!1;for(var o=0;o<t.length;o++)if(allEdges.all[l].from==t[o]){e=!0;break}if(!e)continue;let r=!1;for(var n=0;n<a.length;n++)if(allEdges.all[l].to==a[n]){r=!0;break}e&&r&&s.push(allEdges.all[l])}return s}l.prevTxs=l.txs,l.minTx=o[0].value,l.maxTx=o[l.txs.length-1].value,l.maxTotalTx=t(allEdges.collapsed,"value",!0)[0].value,l.maxBal=t(allNodes,"balVal",!0)[0].balVal,l.maxAvgTx=t(allEdges.collapsed,"avgTxVal",!0)[0].avgTxVal,l.minTime=n[0].time,l.lastTx=l.minTime,l.maxTime=moment().unix(),l.maxTxsNum=t(allEdges.collapsed,"txsNum",!0)[0].txsNum,l.currentId=0,l.sortBy=function(e,a){"time"==e?l.dropText="Most Recent":"value"==e&&a?l.dropText="Transaction Amount ↓":"value"!=e||a||(l.dropText="Transaction Amount ↑"),l.txs=t(l.txs,e,a),l.setPage(l.pager.currentPage)},l.rangeBy=function(e,t,a){return void 0===t&&(t=0),void 0===a&&(a=Number.MAX_VALUE),function(s){return t<=s[e]&&s[e]<=a}},l.setMaxTx=function(){l.isCollapsed?$("#maxTx").val(l.maxTotalTx):$("#maxTx").val(l.maxTx)},l.setMaxBal=function(){$("#maxBal").val(l.maxBal)},l.setMaxAvgTx=function(){$("#maxAvgTx").val(l.maxAvgTx)},l.setMaxTxsNum=function(){$("#maxTxsNum").val(l.maxTxsNum)},l.setFilters=function(){let e,t=l.graphFilters,s=allEdges[l.isCollapsed?"collapsed":"all"],o=[];for(let s in t.node)e=a(allNodes,l.rangeBy(s,t.node[s].min,t.node[s].max));let n=_.map(e,"id");for(var i=0;i<s.length;i++){let e=!1,t=!1;for(var d=0;d<n.length;d++)if(s[i].from==n[d]?e=!0:s[i].to==n[d]&&(t=!0),e&&t){o.push(s[i]);break}}for(let e in t.edge)"time"==e&&(t.edge[e].min=moment(t.edge[e].min,"M/DD/YY hh:mm A").unix(),t.edge[e].max=moment(t.edge[e].max,"M/DD/YY hh:mm A").unix()),o=a(o,l.rangeBy(e,t.edge[e].min,t.edge[e].max)),"time"==e&&(t.edge[e].min=moment.unix(t.edge[e].min).format("M/DD/YY hh:mm A"),t.edge[e].max=moment.unix(t.edge[e].max).format("M/DD/YY hh:mm A"));edges=o,nodes=e,l.isCollapsed&&(o=r(o)),l.setTxs(o),l.currentId=0,drawGraph(!0)},l.highlight=function(e,t){if(t)return network.selectNodes([e],!1),void network.focus(e,{scale:1,animation:!0});if(l.isCollapsed){let t,s;for(var a=0;a<l.txs.length;a++)if(l.txs[a].id==e){t=l.txs[a].source,s=l.txs[a].target;break}for(a=0;a<allEdges.collapsed.length;a++)if(allEdges.collapsed[a].source==t&&allEdges.collapsed[a].target==s){e=allEdges.collapsed[a].id;break}}network.fit({animation:!0}),network.selectEdges([e])},l.select=function(e){if(l.prevTxs=l.txs,e.nodes.length>0){let s=e.nodes[0],o=data.nodes.get(s);if("{{search.label}}"!=o.label&&e.edges.length>0){let s=e.edges,o=[],n=allEdges[l.isCollapsed?"collapsed":"all"];for(var t=0;t<n.length;t++)for(var a=0;a<s.length;a++)if(n[t].id==s[a]){o.push(n[t]),s.splice(a,1);break}l.isCollapsed&&(o=r(o)),l.setTxs(o)}else"{{search.label}}"==o.label&&l.setTxs();return l.selection={type:"node",data:o},void $(function(){$('[data-toggle="tooltip"]').tooltip({trigger:"hover"})})}let s=e.edges[0];if(!l.isCollapsed&&null!=s){let e=data.edges.get(s);return l.selection={type:"tx",data:e},void $(function(){$('[data-toggle="tooltip"]').tooltip({trigger:"hover"})})}for(t=0;t<allEdges.collapsed.length;t++)if(allEdges.collapsed[t].id==s){let e=r([allEdges.collapsed[t]]);return l.setTxs(e),l.selection={type:"txTotal",data:allEdges.collapsed[t]},void $(function(){$('[data-toggle="tooltip"]').tooltip({trigger:"hover"})})}},l.targetBTC=function(e,t){if(null==e)document.getElementById("graph").style="cursor: wait",network.setOptions({physics:{enabled:!0}}),e=l.selection.data.txid,$.get(`https://chain.api.btc.com/v3/tx/${e}?verbose=3`,t=>{t=t.data;let a=data.nodes.get(l.selection.data.to).address;for(var s=0;s<t.outputs.length;s++)if(t.outputs[s].addresses[0]==a){e=t.outputs[s].spent_by_tx;break}null!=e?setTimeout(function(){console.log("next tx"),l.targetBTC(e,l.selection.data.to)},500):setTimeout(function(){stopPhysics()},1e3)});else{var a=new Date;$.get(`https://chain.api.btc.com/v3/tx/${e}?verbose=3`,s=>{s=s.data,console.log(s),e=s.outputs[0].spent_by_tx;for(var o=0;o<s.outputs.length;o++){var n=null;let e=data.nodes.get();for(var r=0;r<e.length;r++)if(e[r].address==s.outputs[o].addresses[0]){n=e[r].id;break}null===n&&(l.currentId++,n=l.currentId,data.nodes.add({id:n,label:s.outputs[o].addresses[0],address:s.outputs[o].addresses[0],balance:0,group:"",lastUpdate:a.getTime()/1e3,url:`https://blockexplorer.com/address/${s.outputs[o].addresses[0]}`,walletName:"none",value:25,img:l.selection.data.img,title:`Address: ${s.outputs[o].addresses[0]}<br>Balance: None<br>Wallet: None<br>Last Updated: ${moment().format("YYYY-MM-DD, hh:mm:ss")}`})),l.currentId++;let i=data.nodes.get(t),d=data.nodes.get(n);data.edges.add({from:t,to:n,id:l.currentId,value:s.outputs[o].value/satoshi,source:i.label,target:d.label,amount:s.outputs[o].value/satoshi,time:s.block_time,txid:s.hash,img:l.selection.data.img,color:{color:"#F9A540"},txidUrl:`https://blockexplorer.com/tx/${s.hash}`,sourceUrl:`https://blockexplorer.com/address/${i.address}`,targetUrl:`https://blockexplorer.com/address/${d.address}`,title:`Collapsed: False<br>Txid: ${s.hash}<br>Total: ${s.outputs[o].value/satoshi}<br>Time: ${moment.unix(s.block_time).format("YYYY-MM-DD, hh:mm:ss")}`}),network.focus(n,{scale:.75,locked:!0,animation:{duration:100}})}null==e||s.outputs_count>1?setTimeout(function(){stopPhysics()},1e3):setTimeout(function(){console.log("next tx"),l.targetBTC(e,n)},750)})}},l.sourceBTC=function(e,t){if(null==e)document.getElementById("graph").style="cursor: wait",network.setOptions({physics:{enabled:!0}}),e=l.selection.data.txid,$.get(`https://chain.api.btc.com/v3/tx/${e}?verbose=3`,t=>{t=t.data;let a=data.nodes.get(l.selection.data.from).address;for(var s=0;s<t.inputs.length;s++)if(t.inputs[s].prev_addresses[0]==a){e=t.outputs[s].spent_by_tx;break}null!=e?setTimeout(function(){console.log("next tx"),l.sourceBTC(e,l.selection.data.to)},500):setTimeout(function(){stopPhysics()},1e3)});else{var a=new Date;$.get(`https://chain.api.btc.com/v3/tx/${e}?verbose=3`,t=>{t=t.data,console.log(t),e=t.inputs[0].prev_tx_hash;for(var s=0;s<t.inputs.length;s++){var o=null;let e=data.nodes.get();for(var n=0;n<e.length;n++)if(e[n].address==t.inputs[s].prev_addresses[0]){o=e[n].id;break}null===o&&(l.currentId++,o=l.currentId,data.nodes.add({id:o,label:t.inputs[s].prev_addresses[0],address:t.inputs[s].prev_addresses[0],balance:0,group:"",lastUpdate:a.getTime()/1e3,url:`https://blockexplorer.com/address/${t.inputs[s].prev_addresses[0]}`,walletName:"none",value:25,img:l.selection.data.img,title:`Address: ${t.inputs[s].prev_addresses[0]}<br>Balance: None<br>Wallet: None<br>Last Updated: ${moment().format("YYYY-MM-DD, hh:mm:ss")}`})),l.currentId++;let r=data.nodes.get(from),i=data.nodes.get(o);data.edges.add({from:from,to:o,id:l.currentId,value:t.inputs[s].prev_value/satoshi,source:r.label,target:i.label,amount:t.inputs[s].prev_value/satoshi,time:t.block_time,txid:t.hash,img:l.selection.data.img,color:{color:"#F9A540"},txidUrl:`https://blockexplorer.com/tx/${t.hash}`,sourceUrl:`https://blockexplorer.com/address/${r.address}`,targetUrl:`https://blockexplorer.com/address/${i.address}`,title:`Collapsed: False<br>Txid: ${t.hash}<br>Total: ${t.inputs[s].prev_value/satoshi}<br>Time: ${moment.unix(t.block_time).format("YYYY-MM-DD, hh:mm:ss")}`}),network.focus(o,{scale:.75,locked:!0,animation:{duration:100}})}null==e||t.inputs_count>1?setTimeout(function(){stopPhysics()},1e3):setTimeout(function(){console.log("next tx"),l.sourceBTC(e,o)},750)})}},edges.length<50&&l.collapse(1==l.maxTxsNum);1==l.maxTxsNum&&($("#hide").prop("disabled",!0),$("#hide").css("background-color","grey"))}])}();